# 多用户通话功能使用指南

## 概述

本文档介绍如何使用智能视频通话系统的多用户通话功能。经过修复，系统现在支持真正的多用户视频通话，而不是之前的自测模式。

## 修复的问题

### 1. 前端通话逻辑问题
- **问题**：前端使用自测模式，与自己通话
- **修复**：改为支持选择其他用户进行通话

### 2. WebSocket用户认证问题
- **问题**：WebSocket连接时用户ID识别混乱
- **修复**：改进用户认证和房间管理逻辑

### 3. 用户搜索和选择功能
- **问题**：用户搜索功能不完整
- **修复**：完善用户搜索、选择和通话发起流程

## 功能特性

### ✅ 已实现功能
- 用户注册和登录
- 用户搜索功能
- 多用户通话发起
- WebSocket实时通信
- WebRTC视频通话
- 通话历史记录
- 安全检测功能

### 🔧 技术架构
- **后端**：Go + Gin + GORM + PostgreSQL
- **前端**：原生JavaScript + WebRTC + WebSocket
- **AI服务**：Python + FastAPI
- **数据库**：PostgreSQL + Redis

## 使用步骤

### 1. 启动系统

```bash
# 启动所有服务
docker-compose up -d

# 检查服务状态
docker-compose ps
```

### 2. 测试多用户通话功能

```bash
# 运行测试脚本
python test_multi_user_call.py
```

### 3. 手动测试流程

#### 步骤1：准备两个浏览器窗口
- 打开两个不同的浏览器窗口或使用无痕模式
- 分别访问：`http://localhost:8080`

#### 步骤2：用户注册/登录
**窗口1（主叫方）**：
1. 点击"注册"按钮
2. 填写用户信息：
   - 用户名：`testuser1`
   - 邮箱：`test1@example.com`
   - 密码：`password123`
   - 姓名：`测试用户1`
3. 点击"注册"完成注册

**窗口2（被叫方）**：
1. 点击"注册"按钮
2. 填写用户信息：
   - 用户名：`testuser2`
   - 邮箱：`test2@example.com`
   - 密码：`password123`
   - 姓名：`测试用户2`
3. 点击"注册"完成注册

#### 步骤3：发起通话
**在主叫方窗口**：
1. 点击"通话"页面
2. 在搜索框中输入：`testuser2`
3. 点击搜索按钮
4. 在搜索结果中点击"通话"按钮
5. 系统会自动发起视频通话

#### 步骤4：接受通话
**在被叫方窗口**：
1. 系统会显示来电通知
2. 点击"接受"开始视频通话
3. 允许浏览器访问摄像头和麦克风

#### 步骤5：验证通话功能
- 检查视频画面是否正常显示
- 测试音频是否正常工作
- 验证安全检测功能
- 测试静音和视频开关功能

## API接口说明

### 用户管理
```http
POST /api/v1/auth/register  # 用户注册
POST /api/v1/auth/login     # 用户登录
GET  /api/v1/user/profile   # 获取用户资料
```

### 用户搜索
```http
GET /api/v1/users/search?query=用户名&limit=10  # 搜索用户
```

### 通话管理
```http
POST /api/v1/calls/start    # 发起通话
POST /api/v1/calls/end      # 结束通话
GET  /api/v1/calls/history  # 获取通话历史
```

### WebSocket连接
```http
GET /ws/call/{callId}?user_id={userId}  # WebSocket信令连接
```

## 故障排除

### 常见问题

#### 1. 无法搜索到用户
**原因**：用户不存在或搜索关键词不正确
**解决**：
- 确保目标用户已注册
- 检查搜索关键词是否正确
- 查看后端日志确认搜索请求

#### 2. WebSocket连接失败
**原因**：网络问题或服务未启动
**解决**：
- 检查后端服务是否正常运行
- 确认WebSocket URL是否正确
- 查看浏览器控制台错误信息

#### 3. 视频通话无法建立
**原因**：WebRTC配置问题或媒体权限
**解决**：
- 确保浏览器支持WebRTC
- 允许浏览器访问摄像头和麦克风
- 检查STUN服务器配置

#### 4. 通话质量差
**原因**：网络带宽不足或配置问题
**解决**：
- 检查网络连接质量
- 调整视频分辨率设置
- 考虑使用TURN服务器

### 调试方法

#### 1. 查看后端日志
```bash
# 查看后端服务日志
docker-compose logs backend

# 实时查看日志
docker-compose logs -f backend
```

#### 2. 查看前端控制台
- 打开浏览器开发者工具
- 查看Console标签页的错误信息
- 查看Network标签页的网络请求

#### 3. 检查数据库
```bash
# 连接数据库
docker-compose exec database psql -U admin -d videocall

# 查看用户表
SELECT * FROM users;

# 查看通话记录
SELECT * FROM calls ORDER BY created_at DESC LIMIT 10;
```

## 性能优化建议

### 1. 网络优化
- 使用CDN加速静态资源
- 配置合适的STUN/TURN服务器
- 启用WebRTC带宽自适应

### 2. 服务器优化
- 增加WebSocket连接池
- 优化数据库查询
- 启用Redis缓存

### 3. 前端优化
- 压缩JavaScript和CSS文件
- 使用WebP格式图片
- 实现懒加载

## 安全考虑

### 1. 认证安全
- 使用HTTPS协议
- 实现JWT令牌过期机制
- 添加请求频率限制

### 2. 数据安全
- 加密敏感数据
- 实现数据备份
- 定期安全审计

### 3. 通信安全
- 使用SRTP加密媒体流
- 验证WebRTC证书
- 实现端到端加密

## 扩展功能

### 计划中的功能
- [ ] 群组通话支持
- [ ] 屏幕共享功能
- [ ] 通话录制功能
- [ ] 移动端应用
- [ ] 国际化支持

### 技术改进
- [ ] 微服务架构
- [ ] 容器化部署
- [ ] 自动化测试
- [ ] 监控告警

## 联系支持

如果在使用过程中遇到问题，请：

1. 查看本文档的故障排除部分
2. 检查系统日志和错误信息
3. 提交Issue到项目仓库
4. 联系技术支持团队

---

**版本**：v1.0  
**更新时间**：2025年7月28日  
**维护者**：开发团队 