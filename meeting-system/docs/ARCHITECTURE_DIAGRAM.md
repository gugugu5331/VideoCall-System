# 🏗️ 系统架构图

## 整体架构

```
╔═══════════════════════════════════════════════════════════════════════════╗
║                           🖥️ 客户端层                                     ║
╠═════════════════════╦═════════════════════╦═════════════════════════════╣
║   Qt6 桌面客户端    ║  Web 浏览器客户端   ║      移动端客户端           ║
║  (Windows/Linux)    ║   (Chrome/Firefox)  ║   (iOS/Android)            ║
╚═════════════════════╩═════════════════════╩═════════════════════════════╝
                              ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                           🌐 网关层                                       ║
╠═════════════════════════════════╦═════════════════════════════════════╣
║      Nginx 负载均衡             ║         API 网关                    ║
║  (8800/443 HTTP/HTTPS)          ║  (路由、限流、认证)                 ║
╚═════════════════════════════════╩═════════════════════════════════════╝
                              ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                        🎯 微服务层 (Go + Gin)                            ║
╠════════╦════════╦════════╦════════╦════════╦════════╦═════════════════╣
║ 用户   ║ 会议   ║ 信令   ║ 媒体   ║  AI    ║ 通知   ║                 ║
║ 服务   ║ 服务   ║ 服务   ║ 服务   ║ 检测   ║ 服务   ║                 ║
║ :8080  ║ :8082  ║ :8081  ║ :8083  ║ :8085  ║ :8085  ║                 ║
║        ║        ║        ║        ║        ║        ║                 ║
║ 认证   ║ 会议   ║WebSocket║ SFU   ║ 情感   ║ 邮件   ║                 ║
║ 授权   ║ 管理   ║ 信令   ║ 转发  ║ 检测   ║ 短信   ║                 ║
║ 用户   ║ 参与者 ║ 协商   ║ 录制  ║ 合成   ║ 推送   ║                 ║
║ 管理   ║ 管理   ║ 媒体   ║ 转码  ║ 检测   ║ 通知   ║                 ║
╚════════╩════════╩════════╩════════╩════════╩════════╩═════════════════╝
                              ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                 🤖 AI 推理层 (Triton + TensorRT)                         ║
╠═════════════════════╦═════════════════════╦═════════════════════════════╣
║  模型仓库           ║   Triton 推理服务    ║    GPU 推理节点             ║
║  (版本管理/热更新)  ║  (HTTP/gRPC)         ║  (TensorRT/CUDA)            ║
║  (批处理/并发)      ║                     ║  (可水平扩展)               ║
╚═════════════════════╩═════════════════════╩═════════════════════════════╝
                              ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                        💾 数据层                                          ║
╠══════════════╦══════════════╦══════════════╦══════════════╦═════════════╣
║ PostgreSQL   ║   Redis      ║   MongoDB    ║   MinIO      ║             ║
║ (主数据库)   ║  (缓存/队列) ║  (AI数据)    ║  (对象存储)  ║             ║
║              ║              ║              ║              ║             ║
║ 用户数据     ║ Session      ║ 推理结果     ║ 会议录制     ║             ║
║ 会议数据     ║ 缓存         ║ 分析数据     ║ 媒体文件     ║             ║
║ 参与者数据   ║ 消息队列     ║ 日志数据     ║ 用户头像     ║             ║
║ 权限数据     ║ 分布式锁     ║              ║ 文档资料     ║             ║
╚══════════════╩══════════════╩══════════════╩══════════════╩═════════════╝
```

---

## 分层详解

### 1️⃣ 客户端层

| 客户端 | 技术栈 | 功能 |
|--------|--------|------|
| **Qt6 桌面** | Qt6/QML + C++ | 完整的会议功能，支持 Windows/Linux/macOS |
| **Web 浏览器** | HTML5 + WebRTC | 轻量级会议，无需安装 |
| **移动端** | iOS/Android SDK | 移动设备上的会议体验 |

### 2️⃣ 网关层

- **Nginx 负载均衡**: 分发客户端请求到多个服务实例
- **API 网关**: 请求路由、速率限制、认证、日志记录

### 3️⃣ 微服务层

| 服务 | 端口 | 职责 |
|------|------|------|
| **用户服务** | 8080 | 用户认证、授权、资料管理 |
| **会议服务** | 8082 | 会议创建、管理、参与者管理 |
| **信令服务** | 8081 | WebSocket 信令、媒体协商 |
| **媒体服务** | 8083 | SFU 媒体转发、录制、转码 |
| **AI 推理服务** | 8085 (gRPC 9085) | ASR、情感检测、合成检测 |
| **通知服务** | 8085 | 邮件、短信、推送通知 |

### 4️⃣ AI 推理层

- **模型管理**: 管理 AI 模型的加载/热身与版本
- **推理引擎**: Triton Inference Server + TensorRT (GPU)
- **推理服务实例**: 通过 HTTP/gRPC 提供推理能力，支持水平扩展

### 5️⃣ 数据层

| 数据库 | 用途 |
|--------|------|
| **PostgreSQL** | 主数据库，存储结构化数据 |
| **Redis** | 缓存、会话、消息队列 |
| **MongoDB** | AI 推理结果、分析数据 |
| **MinIO** | 对象存储，存储文件和媒体 |

---

## 通信流程

### 用户加入会议流程

```
┌─────────────┐
│  客户端     │
└──────┬──────┘
       │ 1. HTTP POST /api/meetings/join
       ▼
┌─────────────────────┐
│  Nginx 负载均衡     │
└──────┬──────────────┘
       │ 2. 转发到会议服务
       ▼
┌─────────────────────┐
│  会议服务 (8082)    │
└──────┬──────────────┘
       │ 3. 验证权限、创建参与者
       ▼
┌─────────────────────┐
│  PostgreSQL         │
└──────┬──────────────┘
       │ 4. 返回会议信息
       ▼
┌─────────────────────┐
│  客户端             │
└─────────────────────┘
       │ 5. WebSocket 连接信令服务
       ▼
┌─────────────────────┐
│  信令服务 (8081)    │
└──────┬──────────────┘
       │ 6. 媒体协商 (SDP/ICE)
       ▼
┌─────────────────────┐
│  媒体服务 (8083)    │
└──────┬──────────────┘
       │ 7. 建立 WebRTC 连接
       ▼
┌─────────────────────┐
│  客户端             │
└─────────────────────┘
```

---

## 数据流向

```
客户端 ◄──────────────────────────────────────────────► 网关
       │                                                │
       │ HTTP/WebSocket                                │
       │                                                │
       ▼                                                ▼
    用户服务 ◄──────────────────────────────────────► 会议服务
       │                                                │
       │ gRPC/HTTP                                      │
       │                                                │
       ▼                                                ▼
    信令服务 ◄──────────────────────────────────────► 媒体服务
       │                                                │
       │ WebSocket/RTP                                  │
       │                                                │
       ▼                                                ▼
    AI 推理服务 ◄──────────────────────────────────► 通知服务
       │                                                │
       │ gRPC                                           │
       │                                                │
       ▼                                                ▼
    PostgreSQL ◄──────────────────────────────────► Redis
       │                                                │
       │ SQL                                            │
       │                                                │
       ▼                                                ▼
    MongoDB ◄──────────────────────────────────────► MinIO
```

---

## 部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Docker Compose                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Nginx       │  │  PostgreSQL  │  │  Redis       │     │
│  │  (8800/443)  │  │  (5432)      │  │  (6379)      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  MongoDB     │  │  MinIO       │  │  Jaeger      │     │
│  │  (27017)     │  │  (9000)      │  │  (6831)      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  User Svc    │  │  Meeting Svc │  │  Signal Svc  │     │
│  │  (8080)      │  │  (8082)      │  │  (8081)      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Media Svc   │  │  AI Svc      │  │  Notify Svc  │     │
│  │  (8083)      │  │  (8085)      │  │  (8085)      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 可观测性架构

```
┌─────────────────────────────────────────────────────────────┐
│                    可观测性栈                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Prometheus  │  │  Grafana     │  │  Jaeger      │     │
│  │  (监控)      │  │  (可视化)    │  │  (追踪)      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │  Loki        │  │  AlertManager│                        │
│  │  (日志)      │  │  (告警)      │                        │
│  └──────────────┘  └──────────────┘                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 相关文档

- [API 文档](API/README.md)
- [部署指南](DEPLOYMENT/README.md)
- [开发指南](DEVELOPMENT/README.md)
