FROM ubuntu:20.04

ARG DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai
SHELL ["/bin/bash", "-c"]

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      ca-certificates tzdata \
      build-essential cmake git curl wget \
      libssl-dev \
      libboost-all-dev \
      libzmq3-dev \
      libgoogle-glog-dev \
      libbsd-dev \
      libsodium-dev \
      libpgm-dev \
      libnorm-dev \
      libkrb5-dev \
      python3 python3-pip && \
    rm -rf /var/lib/apt/lists/*

# 安装依赖（eventpp / simdjson / onnxruntime）以及编译 Edge-LLM-Infra
WORKDIR /work
COPY Edge-LLM-Infra-master /work/Edge-LLM-Infra-master

RUN chmod +x /work/Edge-LLM-Infra-master/docker/build/install/eventpp/install_eventpp.sh && \
    chmod +x /work/Edge-LLM-Infra-master/docker/build/install/simdjson/install_simdjson.sh && \
    chmod +x /work/Edge-LLM-Infra-master/docker/build/install/onnxruntime/install_onnxruntime.sh && \
    /work/Edge-LLM-Infra-master/docker/build/install/eventpp/install_eventpp.sh && \
    /work/Edge-LLM-Infra-master/docker/build/install/simdjson/install_simdjson.sh && \
    /work/Edge-LLM-Infra-master/docker/build/install/onnxruntime/install_onnxruntime.sh

# 构建 stackflow 静态库（安装到 /work/Edge-LLM-Infra-master/install）
RUN cd /work/Edge-LLM-Infra-master/infra-controller && \
    mkdir -p build && cd build && \
    cmake .. && \
    make -j"$(nproc)" && \
    make install

# 构建 unit-manager
RUN cd /work/Edge-LLM-Infra-master/unit-manager && \
    mkdir -p build && cd build && \
    cmake .. && \
    make -j"$(nproc)"

# 构建 llm 推理节点
RUN cd /work/Edge-LLM-Infra-master/node/llm && \
    mkdir -p build && cd build && \
    cmake .. && \
    make -j"$(nproc)"

RUN mkdir -p /work/models /tmp/llm

