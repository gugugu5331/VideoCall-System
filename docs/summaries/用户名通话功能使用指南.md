# 基于用户名的通话功能使用指南

## 🎯 功能概述

本系统已实现完整的基于用户名的通话功能，支持通过用户名搜索用户并发起视频通话。

## ✨ 核心特性

### 1. 用户搜索功能
- **实时搜索**: 输入用户名或姓名进行实时搜索
- **模糊匹配**: 支持部分匹配和模糊搜索
- **用户信息显示**: 显示用户名、全名和头像
- **搜索结果排序**: 按相关度排序显示结果

### 2. 基于用户名的通话
- **用户名通话**: 直接通过用户名发起通话
- **UUID通话**: 兼容原有的UUID通话方式
- **通话状态管理**: 完整的通话生命周期管理
- **WebRTC连接**: 真正的P2P音视频通话

### 3. 用户界面优化
- **搜索界面**: 直观的用户搜索界面
- **结果展示**: 清晰的搜索结果展示
- **一键通话**: 点击即可发起通话
- **状态反馈**: 实时的操作状态反馈

## 🚀 快速开始

### 1. 启动系统
```bash
# Windows
start_username_call_system.bat

# 或手动启动
cd core/backend
go run main.go

# 新终端
cd web_interface
python -m http.server 3000
```

### 2. 访问系统
- **前端界面**: http://localhost:3000
- **后端API**: http://localhost:8000
- **API文档**: http://localhost:8000/swagger/index.html

### 3. 测试功能
```bash
python test_username_call.py
```

## 📱 使用步骤

### 1. 用户注册/登录
1. 打开浏览器访问 http://localhost:3000
2. 点击"注册"按钮创建新账户
3. 或使用现有账户登录

### 2. 搜索用户
1. 登录后点击"通话"页面
2. 在搜索框中输入用户名或姓名
3. 系统会实时显示匹配的用户列表

### 3. 发起通话
1. 在搜索结果中点击"通话"按钮
2. 或先选择用户，然后点击"开始通话"
3. 系统会自动建立WebRTC连接

### 4. 通话管理
- **静音/视频**: 使用控制按钮管理音视频
- **结束通话**: 点击"结束通话"按钮
- **通话历史**: 在"历史"页面查看通话记录

## 🔧 API接口

### 用户搜索API
```http
GET /api/v1/users/search?query=用户名&limit=10
Authorization: Bearer <token>
```

**响应示例**:
```json
{
  "users": [
    {
      "id": 1,
      "uuid": "550e8400-e29b-41d4-a716-446655440000",
      "username": "alice",
      "full_name": "Alice Johnson",
      "avatar_url": "https://example.com/avatar.jpg",
      "status": "active"
    }
  ],
  "count": 1
}
```

### 基于用户名的通话API
```http
POST /api/v1/calls/start
Authorization: Bearer <token>
Content-Type: application/json

{
  "callee_username": "alice",
  "call_type": "video"
}
```

**响应示例**:
```json
{
  "message": "Call initiated",
  "call": {
    "id": 123,
    "uuid": "550e8400-e29b-41d4-a716-446655440001",
    "call_type": "video",
    "status": "initiated",
    "room_id": "room-uuid",
    "callee": {
      "id": 1,
      "username": "alice",
      "full_name": "Alice Johnson"
    }
  }
}
```

## 🎨 前端界面

### 搜索界面
- **搜索输入框**: 支持实时输入和搜索
- **搜索结果**: 显示用户头像、用户名和全名
- **通话按钮**: 一键发起通话
- **选择功能**: 点击用户可选择并高亮显示

### 通话界面
- **视频显示**: 本地和远程视频流
- **控制按钮**: 静音、视频开关、结束通话
- **状态显示**: 通话状态、连接状态、安全检测
- **用户信息**: 显示对方用户信息

## 🧪 测试功能

### 自动化测试
运行 `test_username_call.py` 进行完整功能测试：

1. **健康检查**: 验证后端服务状态
2. **用户注册**: 创建测试用户账户
3. **用户登录**: 测试认证功能
4. **用户搜索**: 测试搜索功能
5. **基于用户名的通话**: 测试通话发起
6. **通话管理**: 测试通话详情和历史

### 手动测试
1. 注册多个测试用户
2. 使用不同用户名进行搜索
3. 测试通话发起和连接
4. 验证通话记录功能

## 🔒 安全特性

### 认证和授权
- JWT令牌认证
- 用户权限验证
- 通话权限检查

### 搜索安全
- 排除当前用户自己
- 只显示活跃用户
- 限制搜索结果数量

### 通话安全
- WebRTC加密传输
- 实时安全检测
- 通话记录审计

## 🐛 故障排除

### 常见问题

#### 1. 搜索无结果
- 检查用户名是否正确
- 确认用户已注册且状态为活跃
- 验证搜索关键词长度（至少2个字符）

#### 2. 通话发起失败
- 检查网络连接
- 确认用户已登录
- 验证被叫用户存在且在线

#### 3. WebRTC连接失败
- 检查浏览器权限设置
- 确认摄像头和麦克风可用
- 验证STUN服务器配置

### 调试模式
```bash
# 启用详细日志
set GIN_MODE=debug
set LOG_LEVEL=debug
```

## 📊 性能优化

### 搜索优化
- 数据库索引优化
- 搜索结果缓存
- 分页加载

### 通话优化
- WebRTC连接优化
- 媒体流质量控制
- 内存使用优化

## 🔮 未来计划

### 短期目标
- [ ] 搜索历史记录
- [ ] 用户在线状态显示
- [ ] 群组通话支持
- [ ] 通话邀请功能

### 长期目标
- [ ] 语音搜索功能
- [ ] 智能推荐用户
- [ ] 跨平台支持
- [ ] 企业级功能

## 📞 技术支持

如有问题或建议，请：
1. 查看浏览器控制台日志
2. 检查后端服务日志
3. 运行测试脚本验证功能
4. 提交Issue报告

---

**注意**: 这是一个完整的基于用户名的通话系统实现，支持真正的WebRTC音视频通话功能。 